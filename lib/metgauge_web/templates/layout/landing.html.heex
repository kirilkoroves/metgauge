<!DOCTYPE html>
<html lang={html_lang(@conn)} class={"main-class #{assigns[:layout_class]}"}>
  <head prefix=
    "og: http://ogp.me/ns# 
     fb: http://ogp.me/ns/fb# 
     product: http://ogp.me/ns/product#">
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="csrf-token" content={csrf_token_value()}>
    <meta name="twitter:title" content={ meta_title(assigns) }>
    <meta name="twitter:description" content={ meta_description(assigns) }>
    <meta name="twitter:image" content={ meta_image(assigns) }>
    <meta name="twitter:card" content="summary_large_image">
    <%= live_title_tag assigns[:page_title] || gettext("MetGauge") %>
    <link rel="apple-touch-icon" sizes="180x180" href={Routes.static_path(@conn, "/assets/images/logo.png")}>
    <link rel="icon" type="image/png" sizes="32x32" href={Routes.static_path(@conn, "/assets/images/icon-32x32.ico")}>
    <link rel="icon" type="image/png" sizes="16x16" href={Routes.static_path(@conn, "/assets/images/icon-16x16.ico")}>
    <link rel="manifest" href={Routes.static_path(@conn, "/assets/images/site.webmanifest")}>
    <link phx-track-static rel="stylesheet" href={Routes.static_path(@conn, "/assets/app.css")}/>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.9.4/min/tiny-slider.js" integrity="sha512-j+F4W//4Pu39at5I8HC8q2l1BNz4OF3ju39HyWeqKQagW6ww3ZF9gFcu8rzUbyTDY7gEo/vqqzGte0UPpo65QQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer phx-track-static type="text/javascript" src={Routes.static_path(@conn, "/assets/app.js")}></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.40/moment-timezone-with-data.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GFQ1V6EY7V"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <script src="https://vjs.zencdn.net/5.15/video.js"></script>
    <link href="https://vjs.zencdn.net/5.15/video-js.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GFQ1V6EY7V');
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11159710635"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'AW-11159710635');
    </script>
    <script>
      gtag('event', 'conversion', {
          'send_to': 'AW-11159710635/94fwCOGrjqYZEKvXrskp',
          'transaction_id': ''
      });
    </script>
    
    <script>
        window.locale = "<%= if Map.get(@conn.assigns, :locale, "en") == "zh_TW", do: "zh", else: Map.get(@conn.assigns, :locale, "en") %>";
        <%= if @conn.assigns.profile != nil do %>
          window.user_id = <%= @conn.assigns.profile.id %>;
        <% end %>
        function getUrlVars()
        {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase.js"></script>
    <script src={Routes.static_path(@conn, "/assets/js/notifications.js")}></script>
  </head>
  <body class={"product #{Map.get(assigns, :layout_class)} #{Map.get(@conn.assigns, :locale)}"}>
    <header>
      <nav class="sitenav">
        <ul>
          <li class="grow logo-wrap">
            <a href="/">
              <img class="logo" src={Routes.static_path(@conn, "/assets/images/logo.png")} />
            </a>
          </li>
          <%= render("_user_menu.html", assigns) %>
          <%= if @current_user do %>
            <li class="menu-item menu-ham">
              <a href="#" class="dropdown-link">
              <%= icon("bars-3", type: "outline", class: "icon-sm") %>
              </a>
              <div class="dropdown">
                <ul class="menu">
                  <div class="usr-section">
                    <div class="user-avatar">
                      <%= if  @conn.assigns.profile == nil or  @conn.assigns.profile.avatar_path == "" or  @conn.assigns.profile.avatar_path == nil do %>
                        <img class="h-6 mx-auto my-3 no_pro_img" src="/assets/svg/generic/profile.svg" />
                      <% else %>
                        <img src={MetgaugeWeb.ProfileView.profile_image_url(@conn, @conn.assigns.profile)} />
                      <% end %>
                    </div>
                    <div class="user-info">
                      <div class="name"><%= @conn.assigns.profile.first_name %> <%= @conn.assigns.profile.last_name %></div>
                    </div>
                  </div>
                  <div class="actions">
                    <ul>
                      <li class="no-hover">
                        <a href={Routes.admin_path(@conn, :index)} class="btn primary"><%= gettext("Go to dashboard") %></a>
                      </li>
                      <li class="no-hover">
                        <hr>
                      </li>
                      <li>
                        <a href={Routes.user_session_path(@conn, :delete)} class="text-gray-500">
                          <%= icon("power", type: "outline", class: "h-5 w-5") %>
                          <%= gettext("Sign out") %>
                        </a>
                      </li>
                    </ul>
                  </div>
                </ul>
              </div>
              <div class="overlay"></div>
            </li>
          <% else %>
            <li class="menu-item menu-ham signed-out">
              <a href="#" class="dropdown-link" style="position: relative; top: -10px">
              <%= icon("bars-3", type: "outline", class: "icon-sm") %>
              </a>
              <div class="dropdown">
                <ul class="menu">
                  <div class="usr-section">
                    <div class="user-avatar">
                        <img class="h-6 mx-auto my-3 no_pro_img" src="/assets/svg/generic/profile.svg" />
                    </div>
                    <div class="user-info">
                      <div class="name"><%= gettext("Become a mover.") %></div>
                    </div>
                  </div>
                  <div class="actions">
                    <ul>
                      <li class="no-hover" style="padding-bottom: 0!important">
                        <a href={Routes.user_registration_path(@conn, :new)} class="btn primary"><%= gettext("Sign up") %></a>
                      </li>
                      <li class="no-hover">
                        <a href={Routes.user_session_path(@conn, :new)} class="btn btn-transparent base"><%= gettext("Sign in") %></a>
                      </li>
                    </ul>
                  </div>
                </ul>
              </div>
              <div class="overlay"></div>
            </li>
          <% end %>
        </ul>
      </nav>
    </header>

    <div class="page-content">
      <%= @inner_content %>
      <!-- Modal -->
      <%= render "_google_sign_issue_modal.html", conn: @conn %>
      <%= render "_facebook_sign_issue_modal.html", conn: @conn %>
    </div>


    <footer class="page-footer">
      <div class="py-6 md:py-10 container mx-auto flex flex-col md:flex-row gap-x-6 gap-y-4 items-center max-w-7xl justify-center">
        <section class="">&copy; <%= Timex.now().year %> <%= gettext "MetGauge" %></section>
        <!--
        <section class="flex gap-3">
          <a href={Routes.page_path(@conn, :privacy_policy)} class="font-semibold"><%= gettext "Privacy Policy" %></a>
          |
          <a href={Routes.page_path(@conn, :terms_of_use)} class="font-semibold"><%= gettext "Terms of Use" %></a>
        </section>
        -->
      </div>
    </footer>

  </body>
  <script>
  $(function() {
      $(".google-btn").click(function(e){
        e.preventDefault();
        e.stopPropagation();
        if(navigator.userAgent.includes("wv")){
          console.log("WebView");
          $("#googleIssueModal").modal("show");
          return false;
        }
        else{
          window.location.href = $(this).attr("data-to");
        }
      });
      $(".facebook-btn").click(function(e){
        e.preventDefault();
        e.stopPropagation();
        if(navigator.userAgent.includes("wv")){
          console.log("WebView");
          $("#googleIssueModal").modal("show");
          return false;
        }
        else{
          window.location.href = $(this).attr("data-to");
        }
      });
      $(".accordion .trigger").click(function(){
          if($(this).hasClass('selected')){
            $(this).removeClass('selected');
            $(this).children('.icon').removeClass('active');
            $(this).next().slideUp("fast", "linear");
            $(this).parent().removeClass('active');
          }else{
              $(".accordion .trigger").removeClass('selected');
              $(this).addClass('selected');
              $(".accordion .trigger").children('.icon').removeClass('active');
              $(this).children('.icon').addClass('active');
              $(".accordion .trigger").next().slideUp("fast", "linear");
              $(this).next().slideDown("fast", "linear");
              $(".accordion .item").removeClass('active');
              $(this).parent().addClass('active');
          }

      });

       $(".show-pass").on("click", function(e){
            e.preventDefault();
            if($(this).parent().find(".pass").attr("type")=="text"){
                $(this).parent().find(".pass").attr("type", "password")
                $(this).parent().find(".hide-pass-line").hide();
            }else{
              $(this).parent().find(".pass").attr("type", "text")
              $(this).parent().find(".hide-pass-line").show();
            }
      });


      $(window).scroll(function() {
        var scrollTop = $(window).scrollTop();
        if($(".first-section").length > 0 ){
          firstSectionOfset = $(".first-section").offset().top - 66;
          if (scrollTop >=  firstSectionOfset) {
          $(".product header").addClass("custom-shadow");
          } else {
            $(".product header").removeClass("custom-shadow");
          }
        }
    });

    $(".menu-notification.show").on("click", function(e){
        e.stopPropagation();
        $(".menu-item").removeClass("opened");
        if($(".notification-container").hasClass("hide")){
          $(".notification-container").removeClass("hide");
          $.ajax({
            url: "/get_notifications",
            success: function(response){
              $(".notification-result").html(response);
              $(".notification-container .loading").hide();
              limit = 10;
              offset = 10;
              reachedEnd = false;
              isActive = false;
            }
          });
        }else{
          $(".notification-container").addClass("hide");
        }
      });

      var limit = 10;
      var offset = 10;
      var reachedEnd = false;
      var isActive = false;


      $(".notification-container").scroll(function(){
          if (!isActive && $(".notification-container").scrollTop() >= $(".notification-result").height() - $(".notification-container").height()){
              isActive = true;
              getNotifications();
          }
      });

       function getNotifications(){
          if(reachedEnd){
              return;
          }
          $(".loading-more").show();
          $.ajax({
              url: "/get_notifications_lazy?limit="+limit+"&offset="+offset,
              method: "GET",
              success: function(response){
                  isActive = false;
                  if(response.reachedEnd){
                      reachedEnd = response.reachedEnd;
                  }else{
                      offset += limit;
                      $(".notification-result").append(response);
                  }
                  $(".loading-more").hide();
              }
          })
      }

      $(".notification-container").on("click", function(e){
        e.stopPropagation();
      });

      $(document).on("click", function(){
        $(".notification-container").addClass("hide");
        $(".menu-notification .over").removeClass("show");
        $(".menu-item").removeClass("opened");
        $(".menu-item .overlay").removeClass("opened");
      });

      $("[data-widget=HeaderMenu]").on("click", function(){
        $(".notification-container").addClass("hide");
          $(".menu-notification .over").removeClass("show");
      });

      $(".close_notifications").on("click", function(e){
        e.preventDefault();
        $(".notification-container").addClass("hide");
        $(".menu-notification .over").removeClass("show");
      });

      $(".menu-item > a").on("click", function(e){
          e.preventDefault();
          var menuItem = $(this).parent();
          $(".notification-container").addClass("hide");
          $(".menu-notification .over").removeClass("show");
          if(menuItem.hasClass("opened")){
            menuItem.removeClass("opened");
            menuItem.find(".overlay").removeClass("opened");
          }else{
            $(".menu-item").removeClass("opened");
            menuItem.addClass("opened");
            menuItem.find(".overlay").addClass("opened");
          }
      });

      $(".menu-item").on("click", function(e){
        e.stopPropagation();
      });

      $(".menu-item .overlay").on("click", function(e){
        $(".menu-item").removeClass("opened");
        $(".menu-item .overlay").removeClass("opened");
      });

  });
  </script>
</html>
